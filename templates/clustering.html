<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Clustering</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Predefined Clustering of Patients</h1>
    <div id="chart"></div>

    <!-- Form for user input -->
    <form id="predictForm">
        <label for="msi">MSI:</label>
        <input type="number" step="0.01" id="msi" name="msi" required>
        <label for="sv">SV:</label>
        <input type="number" step="0.01" id="sv" name="sv" required>
        <button type="submit">Predict and Plot</button>
    </form>

    <script>
        // Fetch initial patient data and render the plot
        let plotData = [];
        let layout = {
            title: 'Predefined Clustering of Patients',
            xaxis: { title: 'SV' },
            yaxis: { title: 'MSI' }
        };

        // Function to fetch and render initial data
        function renderInitialPlot() {
            fetch('/api/patient_data')
                .then(response => response.json())
                .then(data => {
                    const sv = data.map(d => d.sv);
                    const msi = data.map(d => d.msi);
                    const clusters = data.map(d => d.cluster);

                    plotData = [{
                        x: sv,
                        y: msi,
                        mode: 'markers',
                        type: 'scatter',
                        name: 'Patient Data',
                        marker: {
                            size: 12,
                            color: clusters,
                            colorscale: 'Viridis'
                        }
                    }];

                    Plotly.newPlot('chart', plotData, layout);
                });
        }

        // Render the initial plot
        renderInitialPlot();

        // Handle form submission
        document.getElementById('predictForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const msi = parseFloat(document.getElementById('msi').value);
            const sv = parseFloat(document.getElementById('sv').value);

            if (isNaN(msi) || isNaN(sv)) {
                alert("Please enter valid numbers for MSI and SV.");
                return;
            }

            // Send data to the prediction API
            fetch('/api/predict_cluster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ msi, sv }),
            })
            .then(response => response.json())
            .then(data => {
                const predictedCluster = data.predicted_cluster;

                // Remove the previous predicted point if it exists
                if (plotData.length > 1) {
                    plotData.pop();
                }

                // Add the new predicted point
                plotData.push({
                    x: [sv],
                    y: [msi],
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Predicted Point',
                    marker: {
                        size: 15,
                        color: predictedCluster,
                        colorscale: 'Viridis',
                        symbol: 'star'
                    }
                });

                // Update the plot
                Plotly.react('chart', plotData, layout);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>